<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <handlers>
        <!-- Handler for iisnode to handle Node.js server -->
        <add name="iisnode" path="server.js" verb="*" modules="iisnode" resourceType="Unspecified" />
      </handlers>
      <rewrite>
        <rules>
          <!-- Do not interfere with requests for node-inspector debugging -->
          <rule name="NodeInspector" patternSyntax="ECMAScript" stopProcessing="true">
            <match url="^server.js/debug[\/]?" />
          </rule>
          <!-- Map all other URLs to the Node.js entry point (server.js) -->
          <rule name="DynamicContent">
          <match url="^server\.js$" ignoreCase="false" />
            <match url=".*" />
            <conditions>
              <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True"/>
              <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            </conditions>
            <action type="Rewrite" url="server.js"/>
          </rule>
        </rules>
      </rewrite>
      <security>
        <requestFiltering>
          <hiddenSegments>
            <add segment="node_modules"/>
          </hiddenSegments>
        </requestFiltering>
      </security>
      <httpErrors errorMode="Detailed" />
      <!-- Node environment configuration -->
      <iisnode node_env="production" />
    </system.webServer>
  </location>
</configuration>
